"""
‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡∏∞ Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Model StaffProfile
"""
import openpyxl

def parse_excel_staff(file_path):
    """
    Parse Excel file ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£

    ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel:
    - Row 1: ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà...)
    - Row 2: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô I, II, III)
    - Row 3: ‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å
    - Row 4: ‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏¢‡πà‡∏≠‡∏¢ (‡πÄ‡∏Ç‡πá‡∏° 1, 2, 3, 4, RT-PCR, ATK, ‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥)
    - Row 5+: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á

    ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö:
    A: ‡∏•‡∏≥‡∏î‡∏±‡∏ö
    B: ‡∏¢‡∏®
    C: ‡∏ä‡∏∑‡πà‡∏≠
    D: ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
    E: ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å
    F: ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
    G: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
    H: ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
    I: ‡∏≠‡∏≤‡∏¢‡∏∏
    J: ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏Ç‡πá‡∏° 1
    K: ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏Ç‡πá‡∏° 2
    L: ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏Ç‡πá‡∏° 3
    M: ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÄ‡∏Ç‡πá‡∏° 4
    N: RT-PCR
    O: ATK
    P: ‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥
    Q: ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
    """

    wb = openpyxl.load_workbook(file_path)
    ws = wb.active

    # ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (rows 1-4) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å row 5
    data_list = []

    for row_num, row in enumerate(ws.iter_rows(min_row=5, values_only=True), start=5):
        # ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô None) ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
        if row[0] is None:
            continue

        # ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        staff_data = {
            'row_number': row_num,  # ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
            'order': row[0],  # A: ‡∏•‡∏≥‡∏î‡∏±‡∏ö
            'title': row[1] or '',  # B: ‡∏¢‡∏®
            'first_name': row[2] or '',  # C: ‡∏ä‡∏∑‡πà‡∏≠
            'last_name': row[3] or '',  # D: ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
            'national_id': str(row[4]) if row[4] else '',  # E: ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
            'department_name': row[5] or '',  # F: ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
            'person_type': row[6] or '',  # G: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
            'position': row[7] or '',  # H: ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
            'age': row[8] if row[8] else None,  # I: ‡∏≠‡∏≤‡∏¢‡∏∏

            # ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô (1 = True, None/0 = False)
            'vaccine_dose_1': bool(row[9] == 1),  # J: ‡πÄ‡∏Ç‡πá‡∏° 1
            'vaccine_dose_2': bool(row[10] == 1),  # K: ‡πÄ‡∏Ç‡πá‡∏° 2
            'vaccine_dose_3': bool(row[11] == 1),  # L: ‡πÄ‡∏Ç‡πá‡∏° 3
            'vaccine_dose_4': bool(row[12] == 1),  # M: ‡πÄ‡∏Ç‡πá‡∏° 4

            # ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡∏ß‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (1 = True, None/0 = False)
            'test_rt_pcr': bool(row[13] == 1),  # N: RT-PCR
            'test_atk': bool(row[14] == 1),  # O: ATK
            'test_temperature': bool(row[15] == 1),  # P: ‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥

            # Q: ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û - ‡πÑ‡∏ß‡πâ‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
        }

        data_list.append(staff_data)

    return data_list


# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå
if __name__ == '__main__':
    file_path = 'media/files/test_import_pink.xlsx'

    print("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel...")
    data = parse_excel_staff(file_path)

    print(f"\nüìä ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: {len(data)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n")

    # ‡πÅ‡∏™‡∏î‡∏á 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
    print("=" * 100)
    print("‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å:")
    print("=" * 100)

    for i, item in enumerate(data[:5], 1):
        print(f"\n{i}. {item['title']}{item['first_name']} {item['last_name']}")
        print(f"   - ‡πÅ‡∏ñ‡∏ß Excel: {item['row_number']}")
        print(f"   - ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: {item['national_id']}")
        print(f"   - ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: {item['department_name']}")
        print(f"   - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•: {item['person_type']}")
        print(f"   - ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: {item['position']}")
        print(f"   - ‡∏≠‡∏≤‡∏¢‡∏∏: {item['age']}")
        print(f"   - ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô: ‡πÄ‡∏Ç‡πá‡∏°1={item['vaccine_dose_1']}, ‡πÄ‡∏Ç‡πá‡∏°2={item['vaccine_dose_2']}, ‡πÄ‡∏Ç‡πá‡∏°3={item['vaccine_dose_3']}, ‡πÄ‡∏Ç‡πá‡∏°4={item['vaccine_dose_4']}")
        print(f"   - ‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡∏ß‡∏¥‡∏î: RT-PCR={item['test_rt_pcr']}, ATK={item['test_atk']}, ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥={item['test_temperature']}")

    print("\n" + "=" * 100)

    # ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    print("\nüìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô:")
    print(f"   - ‡πÄ‡∏Ç‡πá‡∏° 1: {sum(1 for d in data if d['vaccine_dose_1'])} ‡∏Ñ‡∏ô")
    print(f"   - ‡πÄ‡∏Ç‡πá‡∏° 2: {sum(1 for d in data if d['vaccine_dose_2'])} ‡∏Ñ‡∏ô")
    print(f"   - ‡πÄ‡∏Ç‡πá‡∏° 3: {sum(1 for d in data if d['vaccine_dose_3'])} ‡∏Ñ‡∏ô")
    print(f"   - ‡πÄ‡∏Ç‡πá‡∏° 4: {sum(1 for d in data if d['vaccine_dose_4'])} ‡∏Ñ‡∏ô")

    print("\nüìã ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡∏ß‡∏¥‡∏î:")
    print(f"   - RT-PCR: {sum(1 for d in data if d['test_rt_pcr'])} ‡∏Ñ‡∏ô")
    print(f"   - ATK: {sum(1 for d in data if d['test_atk'])} ‡∏Ñ‡∏ô")
    print(f"   - ‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: {sum(1 for d in data if d['test_temperature'])} ‡∏Ñ‡∏ô")

    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ (‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô)
    print("\nüîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥:")
    national_ids = [d['national_id'] for d in data if d['national_id']]
    duplicates = [nid for nid in set(national_ids) if national_ids.count(nid) > 1]

    if duplicates:
        print(f"   ‚ö†Ô∏è ‡∏û‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ã‡πâ‡∏≥ {len(duplicates)} ‡πÄ‡∏•‡∏Ç:")
        for dup_id in duplicates[:5]:  # ‡πÅ‡∏™‡∏î‡∏á 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
            dup_items = [d for d in data if d['national_id'] == dup_id]
            print(f"      - {dup_id}: ‡∏ã‡πâ‡∏≥ {len(dup_items)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
    else:
        print("   ‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥")
