{% extends 'base.html' %}

{% block title %}‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ï‡∏£{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'badges:badge_list' %}">‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'badges:badge_detail' badge.id %}">{{ badge.badge_number }}</a></li>
                    <li class="breadcrumb-item active">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</li>
                </ol>
            </nav>
            <h2><i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ï‡∏£: {{ badge.badge_number }}</h2>
            <p class="text-muted">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</p>
        </div>
    </div>

    <div class="row">
        <!-- Left: Form -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header badge-header-{{ badge.badge_type.color }}">
                    <strong><i class="bi bi-pencil"></i> ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</strong>
                </div>
                <div class="card-body">
                    <form method="post" id="editBadgeForm">
                        {% csrf_token %}

                        <!-- Display Name -->
                        <div class="mb-3">
                            <label for="display_name" class="form-label">
                                <i class="bi bi-fonts"></i> ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£
                                <small class="text-muted">(‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß)</small>
                            </label>
                            <input type="text" class="form-control" id="display_name" name="display_name"
                                   value="{{ staff_profile.display_name|default:'' }}"
                                   placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏®. ‡∏î‡∏£.‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡∏Å‡∏£‡∏∞‡πÅ‡∏™|‡∏ä‡∏ô‡∏∞‡∏ß‡∏á‡∏®‡πå">
                            <small class="text-muted">
                                ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°: <strong>{{ staff_profile.full_name }}</strong><br>
                                <i class="bi bi-info-circle"></i> ‡πÉ‡∏ä‡πâ <strong>|</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô "‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠|‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•")
                            </small>
                        </div>

                        <!-- Zone -->
                        <div class="mb-3">
                            <label for="zone" class="form-label">
                                <i class="bi bi-geo-alt"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà/‡πÇ‡∏ã‡∏ô
                            </label>
                            <select class="form-select" id="zone" name="zone">
                                <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                                {% for zone in zones %}
                                <option value="{{ zone.id }}" {% if staff_profile.zone and staff_profile.zone.id == zone.id %}selected{% endif %}>
                                    {{ zone.code }} - {{ zone.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong>{{ staff_profile.zone.full_description|default:"-" }}</strong>
                            </small>
                        </div>

                        <!-- Department -->
                        <div class="mb-3">
                            <label for="department" class="form-label">
                                <i class="bi bi-building"></i> ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                            </label>
                            <select class="form-select" id="department" name="department">
                                {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if staff_profile.department.id == dept.id %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong>{{ staff_profile.department.name }}</strong><br>
                                <i class="bi bi-info-circle"></i> ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£ - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà
                            </small>
                        </div>

                        <!-- Badge Type (Color) -->
                        <div class="mb-3">
                            <label for="badge_type" class="form-label">
                                <i class="bi bi-palette"></i> ‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£
                            </label>
                            <select class="form-select" id="badge_type" name="badge_type">
                                {% for bt in badge_types %}
                                <option value="{{ bt.id }}"
                                        {% if badge.badge_type.id == bt.id %}selected{% endif %}
                                        style="background-color: {{ bt.color_code }}; color: black;">
                                    {{ bt.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="alert alert-warning mt-2">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà!
                            </div>
                        </div>

                        <!-- Revision Reason (Required) -->
                        <div class="mb-3">
                            <label for="revision_reason" class="form-label">
                                <i class="bi bi-chat-left-text"></i> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="revision_reason" name="revision_reason"
                                      rows="3" required
                                      placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£ ‡∏Ø‡∏•‡∏Ø"></textarea>
                        </div>

                        <!-- Revision Info -->
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill"></i>
                            <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong><br>
                            - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: <strong>{{ badge.revision_count }} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</strong><br>
                            {% if badge.revision_reason %}
                            - ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <em>{{ badge.revision_reason }}</em>
                            {% endif %}
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <a href="{% url 'badges:badge_detail' badge.id %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right: Current Badge Preview -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header badge-header-{{ badge.badge_type.color }}">
                    <strong><i class="bi bi-eye"></i> ‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</strong>
                </div>
                <div class="card-body text-center">
                    {% if badge.badge_file %}
                        <img src="{{ badge.badge_file.url }}" alt="Badge" class="img-fluid rounded" style="max-height: 500px; border: 2px solid #ddd;">
                    {% else %}
                        <div class="py-5 bg-light rounded">
                            <i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="text-muted mt-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£</p>
                        </div>
                    {% endif %}

                    <!-- Badge Info -->
                    <div class="mt-3 text-start">
                        <h5>
                            <span class="badge" style="background-color: {{ badge.badge_type.color_code }};">
                                {{ badge.badge_number }}
                            </span>
                        </h5>
                        <p class="mb-1"><strong>{{ staff_profile.full_name }}</strong></p>
                        <p class="text-muted mb-1">{{ staff_profile.position }}</p>
                        <p class="text-muted mb-1">{{ staff_profile.department.name }}</p>
                        {% if staff_profile.zone %}
                        <p class="text-muted mb-1">
                            <i class="bi bi-geo-alt"></i> {{ staff_profile.zone.full_description }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card shadow-sm">
                <div class="card-header badge-header-{{ badge.badge_type.color }}">
                    <strong><i class="bi bi-lightbulb"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</strong>
                </div>
                <div class="card-body">
                    <h6 class="text-success">‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà:</h6>
                    <ul class="mb-3">
                        <li><strong>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</strong> - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</li>
                        <li>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ <strong>‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</strong></li>
                        <li>‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)</li>
                    </ul>

                    <h6 class="text-warning">‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà):</h6>
                    <ul class="mb-3">
                        <li>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£ (display_name)</li>
                        <li>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô</li>
                        <li>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ <strong>‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</strong> ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà</li>
                    </ul>

                    <h6 class="text-danger">üî¥ ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£ (‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà):</h6>
                    <ul>
                        <li>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£ (‡∏™‡∏µ)</li>
                        <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</li>
                        <li>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å</li>
                        <li>‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Warn user if changing badge type
document.getElementById('badge_type').addEventListener('change', function() {
    const currentBadgeTypeId = "{{ badge.badge_type.id }}";
    const selectedBadgeTypeId = this.value;

    if (selectedBadgeTypeId !== currentBadgeTypeId) {
        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£! ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà\n\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            // Reset to current badge type
            this.value = currentBadgeTypeId;
        }
    }
});

// Validate form before submit
document.getElementById('editBadgeForm').addEventListener('submit', function(e) {
    const reason = document.getElementById('revision_reason').value.trim();

    if (!reason) {
        e.preventDefault();
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
        document.getElementById('revision_reason').focus();
        return false;
    }

    const currentBadgeTypeId = "{{ badge.badge_type.id }}";
    const selectedBadgeTypeId = document.getElementById('badge_type').value;

    if (selectedBadgeTypeId !== currentBadgeTypeId) {
        if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£?\n\n‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà')) {
            e.preventDefault();
            return false;
        }
    }
});
</script>
{% endblock %}
