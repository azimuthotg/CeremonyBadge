{% extends 'base.html' %}

{% block title %}‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ï‡∏£{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'badges:badge_list' %}">‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'badges:badge_detail' badge.id %}">{{ badge.badge_number }}</a></li>
                    <li class="breadcrumb-item active">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</li>
                </ol>
            </nav>
            <h2><i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ï‡∏£: {{ badge.badge_number }}</h2>
            <p class="text-muted">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</p>
        </div>
    </div>

    <div class="row">
        <!-- Left: Form -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header badge-header-{{ badge.badge_type.color }}">
                    <strong><i class="bi bi-pencil"></i> ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</strong>
                </div>
                <div class="card-body">
                    <form method="post" id="editBadgeForm">
                        {% csrf_token %}

                        <!-- Display Name -->
                        <div class="mb-3">
                            <label for="display_name" class="form-label">
                                <i class="bi bi-fonts"></i> ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£
                                <small class="text-muted">(‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß)</small>
                            </label>
                            <input type="text" class="form-control" id="display_name" name="display_name"
                                   value="{{ staff_profile.display_name|default:'' }}"
                                   placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏®. ‡∏î‡∏£.‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡∏Å‡∏£‡∏∞‡πÅ‡∏™|‡∏ä‡∏ô‡∏∞‡∏ß‡∏á‡∏®‡πå">
                            <small class="text-muted">
                                ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°: <strong>{{ staff_profile.full_name }}</strong><br>
                                <i class="bi bi-info-circle"></i> ‡πÉ‡∏ä‡πâ <strong>|</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô "‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠|‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•")
                            </small>
                        </div>

                        <!-- Zone -->
                        <div class="mb-3">
                            <label for="zone" class="form-label">
                                <i class="bi bi-geo-alt"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà/‡πÇ‡∏ã‡∏ô
                            </label>
                            <select class="form-select" id="zone" name="zone">
                                <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                                {% for zone in zones %}
                                <option value="{{ zone.id }}" {% if staff_profile.zone and staff_profile.zone.id == zone.id %}selected{% endif %}>
                                    {{ zone.code }} - {{ zone.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong>{{ staff_profile.zone.full_description|default:"-" }}</strong>
                            </small>
                        </div>

                        <!-- Department -->
                        <div class="mb-3">
                            <label for="department" class="form-label">
                                <i class="bi bi-building"></i> ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                            </label>
                            <select class="form-select" id="department" name="department">
                                {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if staff_profile.department.id == dept.id %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong>{{ staff_profile.department.name }}</strong><br>
                                <i class="bi bi-info-circle"></i> ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£ - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà
                            </small>
                        </div>

                        <!-- Badge Type (Color) -->
                        <div class="mb-3">
                            <label for="badge_type" class="form-label">
                                <i class="bi bi-palette"></i> ‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£
                            </label>
                            <select class="form-select" id="badge_type" name="badge_type">
                                {% for bt in badge_types %}
                                <option value="{{ bt.id }}"
                                        {% if badge.badge_type.id == bt.id %}selected{% endif %}
                                        style="background-color: {{ bt.color_code }}; color: black;">
                                    {{ bt.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="alert alert-warning mt-2">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà!
                            </div>
                        </div>

                        <!-- Photo Section -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-camera-fill"></i> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£
                            </label>
                            <div class="card">
                                <div class="card-body text-center">
                                    {% if staff_profile.photo and staff_profile.photo.cropped_photo %}
                                        <img id="current-photo-preview" src="{{ staff_profile.photo.cropped_photo.url }}"
                                             alt="Photo" class="img-fluid rounded mb-2"
                                             style="max-height: 200px; border: 2px solid #ddd;">
                                    {% else %}
                                        <div id="current-photo-preview" class="py-4 bg-light rounded mb-2">
                                            <i class="bi bi-person-circle" style="font-size: 4rem; color: #ccc;"></i>
                                            <p class="text-muted mt-2 mb-0">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                                        </div>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#photoUploadModal">
                                        <i class="bi bi-camera"></i>
                                        {% if staff_profile.photo %}‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ{% else %}‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ{% endif %}
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ - ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà
                            </small>
                        </div>

                        <!-- Revision Reason (Required) -->
                        <div class="mb-3">
                            <label for="revision_reason" class="form-label">
                                <i class="bi bi-chat-left-text"></i> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="revision_reason" name="revision_reason"
                                      rows="3" required
                                      placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£ ‡∏Ø‡∏•‡∏Ø"></textarea>
                        </div>

                        <!-- Revision Info -->
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill"></i>
                            <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong><br>
                            - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: <strong>{{ badge.revision_count }} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</strong><br>
                            {% if badge.revision_reason %}
                            - ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <em>{{ badge.revision_reason }}</em>
                            {% endif %}
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <a href="{% url 'badges:badge_detail' badge.id %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right: Current Badge Preview -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header badge-header-{{ badge.badge_type.color }}">
                    <strong><i class="bi bi-eye"></i> ‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</strong>
                </div>
                <div class="card-body text-center">
                    {% if badge.badge_file %}
                        <img src="{{ badge.badge_file.url }}" alt="Badge" class="img-fluid rounded" style="max-height: 500px; border: 2px solid #ddd;">
                    {% else %}
                        <div class="py-5 bg-light rounded">
                            <i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="text-muted mt-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£</p>
                        </div>
                    {% endif %}

                    <!-- Badge Info -->
                    <div class="mt-3 text-start">
                        <h5>
                            <span class="badge" style="background-color: {{ badge.badge_type.color_code }};">
                                {{ badge.badge_number }}
                            </span>
                        </h5>
                        <p class="mb-1"><strong>{{ staff_profile.full_name }}</strong></p>
                        <p class="text-muted mb-1">{{ staff_profile.position }}</p>
                        <p class="text-muted mb-1">{{ staff_profile.department.name }}</p>
                        {% if staff_profile.zone %}
                        <p class="text-muted mb-1">
                            <i class="bi bi-geo-alt"></i> {{ staff_profile.zone.full_description }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card shadow-sm">
                <div class="card-header badge-header-{{ badge.badge_type.color }}">
                    <strong><i class="bi bi-lightbulb"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</strong>
                </div>
                <div class="card-body">
                    <h6 class="text-success">‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà:</h6>
                    <ul class="mb-3">
                        <li><strong>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</strong> - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</li>
                        <li>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ <strong>‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</strong></li>
                        <li>‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)</li>
                    </ul>

                    <h6 class="text-warning">‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà):</h6>
                    <ul class="mb-3">
                        <li>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏ö‡∏±‡∏ï‡∏£ (display_name)</li>
                        <li>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô</li>
                        <li>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ <strong>‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</strong> ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà</li>
                    </ul>

                    <h6 class="text-danger">üî¥ ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£ (‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà):</h6>
                    <ul>
                        <li>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£ (‡∏™‡∏µ)</li>
                        <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</li>
                        <li>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å</li>
                        <li>‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Upload Modal -->
<div class="modal fade" id="photoUploadModal" tabindex="-1" aria-labelledby="photoUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header badge-header-{{ badge.badge_type.color }}">
                <h5 class="modal-title" id="photoUploadModalLabel">
                    <i class="bi bi-camera-fill"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="photoUploadForm" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong>
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏µ‡∏≠‡πà‡∏≠‡∏ô ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB
                    </div>

                    <div class="mb-3">
                        <label for="photo_file" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢</label>
                        <input type="file" class="form-control" id="photo_file" name="photo" accept="image/*" required>
                    </div>

                    <!-- Image Preview & Crop Container -->
                    <div id="modal-crop-container" style="display:none;">
                        <h6 class="mt-4">‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</h6>
                        <p class="text-muted small">‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô 3:4)</p>

                        <!-- Control Buttons (Moved to Top) -->
                        <div class="text-center mb-3">
                            <button type="button" id="modal-btn-rotate-left" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="bi bi-arrow-counterclockwise"></i> ‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
                            </button>
                            <button type="button" id="modal-btn-rotate-right" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="bi bi-arrow-clockwise"></i> ‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡∏ß‡∏≤
                            </button>
                            <button type="button" id="modal-btn-reset" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                            </button>
                        </div>

                        <!-- Image with max-width 400px -->
                        <div class="text-center mb-3">
                            <img id="modal-image-to-crop" src="" style="max-width: 400px; width: 100%; display: block; margin: 0 auto;">
                        </div>
                    </div>

                    <!-- Hidden fields for crop data -->
                    <input type="hidden" id="modal_crop_x" name="crop_x">
                    <input type="hidden" id="modal_crop_y" name="crop_y">
                    <input type="hidden" id="modal_crop_width" name="crop_width">
                    <input type="hidden" id="modal_crop_height" name="crop_height">

                    <!-- Upload Progress -->
                    <div id="upload-progress" class="mt-3" style="display:none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                        <p class="text-center text-muted mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà...</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" id="btn-upload-photo" class="btn btn-primary">
                    <i class="bi bi-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Warn user if changing badge type
document.getElementById('badge_type').addEventListener('change', function() {
    const currentBadgeTypeId = "{{ badge.badge_type.id }}";
    const selectedBadgeTypeId = this.value;

    if (selectedBadgeTypeId !== currentBadgeTypeId) {
        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£! ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà\n\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            // Reset to current badge type
            this.value = currentBadgeTypeId;
        }
    }
});

// Validate form before submit
document.getElementById('editBadgeForm').addEventListener('submit', function(e) {
    const reason = document.getElementById('revision_reason').value.trim();

    if (!reason) {
        e.preventDefault();
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
        document.getElementById('revision_reason').focus();
        return false;
    }

    const currentBadgeTypeId = "{{ badge.badge_type.id }}";
    const selectedBadgeTypeId = document.getElementById('badge_type').value;

    if (selectedBadgeTypeId !== currentBadgeTypeId) {
        if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ö‡∏±‡∏ï‡∏£?\n\n‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà')) {
            e.preventDefault();
            return false;
        }
    }
});
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script>
// Photo Upload Modal - Cropper.js
let modalCropper = null;

document.getElementById('photo_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB');
            e.target.value = '';
            return;
        }

        // Validate file type
        if (!file.type.match('image.*')) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            e.target.value = '';
            return;
        }

        // Show crop container
        const cropContainer = document.getElementById('modal-crop-container');
        cropContainer.style.display = 'block';

        // Load image
        const reader = new FileReader();
        reader.onload = function(event) {
            const image = document.getElementById('modal-image-to-crop');
            image.src = event.target.result;

            // Destroy previous cropper if exists
            if (modalCropper) {
                modalCropper.destroy();
            }

            // Initialize Cropper.js with 3:4 aspect ratio
            modalCropper = new Cropper(image, {
                aspectRatio: 3 / 4,
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true,
                background: false,
                crop(event) {
                    // Update hidden fields with crop data
                    document.getElementById('modal_crop_x').value = Math.round(event.detail.x);
                    document.getElementById('modal_crop_y').value = Math.round(event.detail.y);
                    document.getElementById('modal_crop_width').value = Math.round(event.detail.width);
                    document.getElementById('modal_crop_height').value = Math.round(event.detail.height);
                }
            });
        };
        reader.readAsDataURL(file);
    }
});

// Modal - Rotate left button
document.getElementById('modal-btn-rotate-left').addEventListener('click', function() {
    if (modalCropper) {
        modalCropper.rotate(-90);
    }
});

// Modal - Rotate right button
document.getElementById('modal-btn-rotate-right').addEventListener('click', function() {
    if (modalCropper) {
        modalCropper.rotate(90);
    }
});

// Modal - Reset button
document.getElementById('modal-btn-reset').addEventListener('click', function() {
    if (modalCropper) {
        modalCropper.reset();
    }
});

// Upload Photo Button
document.getElementById('btn-upload-photo').addEventListener('click', function() {
    const fileInput = document.getElementById('photo_file');
    if (!fileInput.files || !fileInput.files[0]) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢');
        return;
    }

    // Check if crop data exists
    const cropX = document.getElementById('modal_crop_x').value;
    if (!cropX) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏™‡∏£‡πá‡∏à');
        return;
    }

    // Prepare FormData
    const formData = new FormData(document.getElementById('photoUploadForm'));

    // Show progress
    document.getElementById('upload-progress').style.display = 'block';
    document.getElementById('btn-upload-photo').disabled = true;

    // AJAX Upload
    fetch("{% url 'badges:update_badge_photo' badge.id %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - Update preview and badge image
            if (data.photo_url) {
                // Update photo preview in form
                const photoPreview = document.getElementById('current-photo-preview');
                if (photoPreview.tagName === 'IMG') {
                    photoPreview.src = data.photo_url + '?t=' + new Date().getTime();
                } else {
                    // Replace placeholder div with img
                    const newImg = document.createElement('img');
                    newImg.id = 'current-photo-preview';
                    newImg.src = data.photo_url + '?t=' + new Date().getTime();
                    newImg.alt = 'Photo';
                    newImg.className = 'img-fluid rounded mb-2';
                    newImg.style.cssText = 'max-height: 200px; border: 2px solid #ddd;';
                    photoPreview.parentNode.replaceChild(newImg, photoPreview);
                }
            }

            // Update badge preview on right side
            if (data.badge_image_url) {
                const badgeImg = document.querySelector('.card-body img[alt="Badge"]');
                if (badgeImg) {
                    badgeImg.src = data.badge_image_url + '?t=' + new Date().getTime();
                }
            }

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('photoUploadModal'));
            modal.hide();

            // Reset form
            document.getElementById('photoUploadForm').reset();
            document.getElementById('modal-crop-container').style.display = 'none';
            if (modalCropper) {
                modalCropper.destroy();
                modalCropper = null;
            }

            // Show success message
            alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        } else {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ' + error.message);
    })
    .finally(() => {
        // Hide progress and enable button
        document.getElementById('upload-progress').style.display = 'none';
        document.getElementById('btn-upload-photo').disabled = false;
    });
});

// Reset modal when closed
document.getElementById('photoUploadModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('photoUploadForm').reset();
    document.getElementById('modal-crop-container').style.display = 'none';
    if (modalCropper) {
        modalCropper.destroy();
        modalCropper = null;
    }
});
</script>
{% endblock %}
