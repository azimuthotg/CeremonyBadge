{% extends 'base.html' %}

{% block title %}‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="bi bi-printer"></i> ‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå</h2>
            <p class="text-muted">‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå</p>
        </div>
    </div>

    <!-- Badge Number Info Cards -->
    <div class="row mb-3">
        {% for info in badge_info %}
        <div class="col-md-3 mb-2">
            <div class="card border-start border-4" style="border-color: {{ info.badge_type.color_code }} !important;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-0" style="font-size: 0.9rem;">{{ info.badge_type.name }}</h6>
                            <div class="text-muted" style="font-size: 0.75rem;">
                                <span class="me-2">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <strong>{{ info.latest_badge_number }}</strong></span>
                            </div>
                            <div class="text-success" style="font-size: 0.8rem;">
                                ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: <strong>{{ info.next_badge_number }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Badge Type Tabs -->
    <div class="row mb-3">
        <div class="col-12">
            <ul class="nav nav-pills" id="badgeTypeTabs" role="tablist">
                {% for data in badge_data %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if data.badge_type.id|stringformat:'s' == active_badge_id %}active{% endif %}"
                            id="badge-{{ data.badge_type.id }}-tab"
                            data-bs-toggle="pill"
                            data-bs-target="#badge-{{ data.badge_type.id }}"
                            type="button"
                            role="tab"
                            style="background-color: {{ data.badge_type.color_code }}; border-color: {{ data.badge_type.color_code }}; color: black; {% if data.badge_type.id|stringformat:'s' != active_badge_id %}opacity: 0.6;{% endif %}">
                        {{ data.badge_type.name }}
                        <span class="badge bg-light text-dark ms-1">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß {{ data.printed_count }}/{{ data.total_count }} ‡∏ö‡∏±‡∏ï‡∏£</span>
                    </button>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Select All Checkbox -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="select-all-badges">
                <label class="form-check-label fw-bold" for="select-all-badges">
                    <i class="bi bi-check-square"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ
                </label>
            </div>
        </div>
    </div>

    <!-- Search, Filter and Bulk Actions -->
    <div class="row mb-4">
        <div class="col-md-8">
            <form method="get" class="row g-2">
                <div class="col-md-6">
                    <input type="text" name="search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•..." value="{{ search }}">
                </div>
                <div class="col-md-4">
                    <select name="department" class="form-select" id="department-filter">
                        <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if dept.id|stringformat:'s' == department_filter %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                        {% empty %}
                        <!-- DEBUG: No departments found -->
                        {% endfor %}
                    </select>
                    <!-- DEBUG: departments count = {{ departments|length }} -->
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" type="submit">
                        <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                </div>
                {% if search or department_filter %}
                <div class="col-12">
                    <a href="{% url 'badges:badge_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-x"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                    </a>
                </div>
                {% endif %}
            </form>
        </div>
        <div class="col-md-4 text-end">
            <button type="button" class="btn btn-warning bulk-action-btn me-2" id="bulk-reset-btn" style="display: none;" data-bs-toggle="modal" data-bs-target="#bulkResetPrintModal">
                <i class="bi bi-arrow-counterclockwise"></i> Reset ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå (<span class="selected-count">0</span>)
            </button>
            <button type="button" class="btn btn-danger bulk-action-btn" id="bulk-delete-btn" style="display: none;" data-bs-toggle="modal" data-bs-target="#bulkDeleteModal">
                <i class="bi bi-trash"></i> ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (<span class="selected-count">0</span>)
            </button>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="badgeTypeTabsContent">
        {% for data in badge_data %}
        <div class="tab-pane fade {% if data.badge_type.id|stringformat:'s' == active_badge_id %}show active{% endif %}"
             id="badge-{{ data.badge_type.id }}"
             role="tabpanel">

            <!-- Badges Grid -->
            <div class="row">
                {% if data.badges %}
                    {% for badge in data.badges %}
                    <div class="col-md-3 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body p-2">
                                <!-- Header: Checkbox, Badge Number, Menu -->
                                <div class="d-flex justify-content-between align-items-center mb-2 px-2 pt-1">
                                    <div>
                                        <input type="checkbox" class="form-check-input badge-checkbox me-2" value="{{ badge.id }}" data-badge-type="{{ badge.badge_type.id }}">
                                        <small class="text-muted">{{ badge.badge_number }}</small>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-muted p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="event.stopPropagation();">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="{{ badge.badge_file.url }}" download onclick="event.stopPropagation();">
                                                    <i class="bi bi-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteModal{{ badge.id }}" onclick="event.stopPropagation();">
                                                    <i class="bi bi-trash"></i> ‡∏•‡∏ö
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Badge Image (Clickable) -->
                                <a href="{% url 'badges:badge_detail' badge.id %}" class="text-decoration-none">
                                    <div class="position-relative text-center mb-2">
                                        {% if badge.badge_file %}
                                            <img src="{{ badge.badge_file.url }}" alt="Badge" class="img-fluid rounded" style="max-height: 280px; border: 2px solid #ddd;">
                                            <!-- Status Overlay (‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô) -->
                                            {% if badge.is_printed %}
                                                <span class="position-absolute top-0 start-0 m-2 badge bg-success rounded-circle" style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß {{ badge.printed_count }} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
                                                    <i class="bi bi-check-lg"></i>
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <div class="py-5 bg-light rounded">
                                                <i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Badge Info -->
                                    <div class="px-2">
                                        <p class="mb-1 text-dark">
                                            <strong style="font-size: 0.9rem;">{{ badge.staff_profile.full_name }}</strong>
                                            <small class="text-muted">| {{ badge.staff_profile.position }}</small>
                                        </p>
                                        <p class="mb-0">
                                            <small class="text-muted"><i class="bi bi-building"></i> {{ badge.staff_profile.department.name }}</small>
                                        </p>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Modal -->
                    <div class="modal fade" id="deleteModal{{ badge.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ï‡∏£</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <form method="post" action="{% url 'badges:delete_badge' badge.id %}">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="alert alert-danger">
                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                            <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!
                                        </div>
                                        <p><strong>‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö:</strong></p>
                                        <ul>
                                            <li>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: <strong>{{ badge.badge_number }}</strong></li>
                                            <li>‡∏ä‡∏∑‡πà‡∏≠: <strong>{{ badge.staff_profile.full_name }}</strong></li>
                                            <li>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: <strong>{{ badge.badge_type.name }}</strong></li>
                                        </ul>
                                        <p class="text-muted">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ?</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                        <button type="submit" class="btn btn-danger">
                                            <i class="bi bi-trash"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 4rem;"></i>
                            <h5 class="mt-3">
                                {% if search %}
                                    ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "{{ search }}"
                                {% else %}
                                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ
                                {% endif %}
                            </h5>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Bulk Reset Print Modal -->
<div class="modal fade" id="bulkResetPrintModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-arrow-counterclockwise"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Reset ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="bulk-reset-form" action="{% url 'badges:bulk_reset_print' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i>
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Å‡∏≤‡∏£ Reset ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ï‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå" ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 0
                    </div>
                    <p><strong>‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á Reset ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£ <span id="bulk-reset-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong></p>
                    <p class="text-muted">‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-counterclockwise"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Reset
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Delete Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ï‡∏£</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="bulk-delete-form" action="{% url 'badges:bulk_delete_badge' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!
                    </div>
                    <p><strong>‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ö‡∏±‡∏ï‡∏£ <span id="bulk-delete-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong></p>
                    <p class="text-muted">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    // Wait for DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    function init() {
        console.log('Initializing badge list tab memory and bulk actions...');
        initTabMemory();
        restoreActiveTab();
        initBulkActions();
        initSelectAll();
    }

    // Tab Memory with localStorage
    function initTabMemory() {
        // Listen to all tab button clicks
        document.querySelectorAll('[data-bs-toggle="pill"]').forEach(function(tabButton) {
            tabButton.addEventListener('shown.bs.tab', function(event) {
                // Extract badge type ID from tab target
                const target = event.target.getAttribute('data-bs-target');
                const badgeTypeId = target.replace('#badge-', '');

                // Save to localStorage
                localStorage.setItem('badge_list_active_tab', badgeTypeId);
                console.log('Saved active tab (badge list):', badgeTypeId);
            });
        });
    }

    function restoreActiveTab() {
        // Get saved tab from localStorage
        const savedTab = localStorage.getItem('badge_list_active_tab');

        if (savedTab) {
            // Find and activate the saved tab
            const tabButton = document.getElementById('badge-' + savedTab + '-tab');
            if (tabButton) {
                const tab = new bootstrap.Tab(tabButton);
                tab.show();
                console.log('Restored active tab (badge list):', savedTab);
            }
        }
    }

    // Bulk Actions
    function initBulkActions() {
        const bulkResetBtn = document.getElementById('bulk-reset-btn');
        const bulkResetForm = document.getElementById('bulk-reset-form');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const bulkDeleteForm = document.getElementById('bulk-delete-form');

        // Listen to all checkboxes
        document.querySelectorAll('.badge-checkbox').forEach(function(checkbox) {
            checkbox.addEventListener('change', updateBulkActions);
        });

        // Handle bulk reset form submission
        if (bulkResetForm) {
            bulkResetForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Get selected badge IDs
                const selectedIds = [];
                document.querySelectorAll('.badge-checkbox:checked').forEach(function(checkbox) {
                    selectedIds.push(checkbox.value);
                });

                if (selectedIds.length === 0) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Reset ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå');
                    return;
                }

                // Add hidden inputs to form
                selectedIds.forEach(function(id) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'badge_ids';
                    input.value = id;
                    bulkResetForm.appendChild(input);
                });

                // Submit form
                bulkResetForm.submit();
            });
        }

        // Handle bulk delete form submission
        if (bulkDeleteForm) {
            bulkDeleteForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Get selected badge IDs
                const selectedIds = [];
                document.querySelectorAll('.badge-checkbox:checked').forEach(function(checkbox) {
                    selectedIds.push(checkbox.value);
                });

                if (selectedIds.length === 0) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                    return;
                }

                // Add hidden inputs to form
                selectedIds.forEach(function(id) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'badge_ids';
                    input.value = id;
                    bulkDeleteForm.appendChild(input);
                });

                // Submit form
                bulkDeleteForm.submit();
            });
        }

        // Update bulk reset modal when shown
        const bulkResetModal = document.getElementById('bulkResetPrintModal');
        if (bulkResetModal) {
            bulkResetModal.addEventListener('show.bs.modal', function() {
                const selectedCount = document.querySelectorAll('.badge-checkbox:checked').length;
                document.getElementById('bulk-reset-count').textContent = selectedCount;
            });
        }

        // Update bulk delete modal when shown
        const bulkDeleteModal = document.getElementById('bulkDeleteModal');
        if (bulkDeleteModal) {
            bulkDeleteModal.addEventListener('show.bs.modal', function() {
                const selectedCount = document.querySelectorAll('.badge-checkbox:checked').length;
                document.getElementById('bulk-delete-count').textContent = selectedCount;
            });
        }
    }

    function updateBulkActions() {
        const selectedCheckboxes = document.querySelectorAll('.badge-checkbox:checked');
        const selectedCount = selectedCheckboxes.length;
        const bulkResetBtn = document.getElementById('bulk-reset-btn');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

        // Update button visibility and count
        if (selectedCount > 0) {
            bulkResetBtn.style.display = 'inline-block';
            bulkDeleteBtn.style.display = 'inline-block';

            // Update count for both buttons
            document.querySelectorAll('.selected-count').forEach(function(span) {
                span.textContent = selectedCount;
            });
        } else {
            bulkResetBtn.style.display = 'none';
            bulkDeleteBtn.style.display = 'none';
        }
    }

    // Select All functionality
    function initSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all-badges');
        if (!selectAllCheckbox) return;

        selectAllCheckbox.addEventListener('change', function() {
            // Get active tab
            const activeTab = document.querySelector('.tab-pane.active');
            if (!activeTab) return;

            // Select/deselect all checkboxes in active tab
            const checkboxes = activeTab.querySelectorAll('.badge-checkbox');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = selectAllCheckbox.checked;
            });

            // Update bulk action buttons
            updateBulkActions();
        });

        // Listen to tab changes - reset select-all when switching tabs
        document.querySelectorAll('[data-bs-toggle="pill"]').forEach(function(tabButton) {
            tabButton.addEventListener('shown.bs.tab', function() {
                selectAllCheckbox.checked = false;
                updateBulkActions();
            });
        });

        // Listen to individual checkbox changes to update "select all" state
        document.querySelectorAll('.badge-checkbox').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                // Check if all visible checkboxes in active tab are selected
                const activeTab = document.querySelector('.tab-pane.active');
                if (!activeTab) return;

                const visibleCheckboxes = activeTab.querySelectorAll('.badge-checkbox');
                const checkedCheckboxes = activeTab.querySelectorAll('.badge-checkbox:checked');

                // Update select-all checkbox state
                selectAllCheckbox.checked = (visibleCheckboxes.length > 0 && visibleCheckboxes.length === checkedCheckboxes.length);
            });
        });
    }
})();
</script>
{% endblock %}
