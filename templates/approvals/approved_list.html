{% extends 'base.html' %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    {% csrf_token %}
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="bi bi-check-circle-fill text-success"></i> ‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</h2>
            <p class="text-muted">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£</p>
        </div>
    </div>

    <!-- Badge Number Info Cards -->
    <div class="row mb-3">
        {% for data in badge_data %}
        <div class="col-md-3 mb-2">
            <div class="card border-start border-4" style="border-color: {{ data.badge_type.color_code }} !important;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-0" style="font-size: 0.9rem;">{{ data.badge_type.name }}</h6>
                            <div class="text-muted" style="font-size: 0.75rem;">
                                <span class="me-2">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <strong>{{ data.latest_badge_number }}</strong></span>
                            </div>
                            <div class="text-success" style="font-size: 0.8rem;">
                                ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: <strong>{{ data.next_badge_number }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Badge Type Tabs -->
    <div class="row mb-3">
        <div class="col-12">
            <ul class="nav nav-pills" id="badgeTypeTabs" role="tablist">
                {% for data in badge_data %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if data.badge_type.id|stringformat:'s' == active_badge_id %}active{% endif %}"
                            id="badge-{{ data.badge_type.id }}-tab"
                            data-bs-toggle="pill"
                            data-bs-target="#badge-{{ data.badge_type.id }}"
                            type="button"
                            role="tab"
                            style="background-color: {{ data.badge_type.color_code }} !important; border-color: {{ data.badge_type.color_code }} !important; color: black !important; {% if data.badge_type.id|stringformat:'s' != active_badge_id %}opacity: 0.6;{% endif %}">
                        {{ data.badge_type.name }}
                        <span class="badge bg-light text-dark ms-1">üìù ‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß {{ data.badge_created_count }}/{{ data.total_count }} ‡∏ö‡∏±‡∏ï‡∏£</span>
                    </button>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-4">
            <form method="get" class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" name="search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á..." value="{{ search }}">
                <input type="hidden" name="department" value="{{ department_filter }}">
                <button class="btn btn-outline-primary" type="submit">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                {% if search %}
                <a href="?department={{ department_filter }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x"></i>
                </a>
                {% endif %}
            </form>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-building"></i></span>
                <select class="form-select" name="department" onchange="filterByDepartment(this.value)">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if department_filter == dept.id|stringformat:'s' %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Bar (hidden by default) -->
    <div id="bulkActionsBar" class="row mb-3" style="display: none;">
        <div class="col-12">
            <div class="alert alert-primary d-flex justify-content-between align-items-center">
                <div>
                    <strong><span id="selectedCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</strong>
                </div>
                <div>
                    <button type="button" class="btn btn-warning me-2" id="bulkEditBtn">
                        <i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </button>
                    <button type="button" class="btn btn-danger me-2" id="bulkSendBackBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                    <button type="button" class="btn btn-success me-2" id="bulkCreateBadgeBtn">
                        <i class="bi bi-credit-card"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </button>
                    <button type="button" class="btn btn-secondary" id="clearSelectionBtn">
                        <i class="bi bi-x"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="badgeTypeTabsContent">
        {% for data in badge_data %}
        <div class="tab-pane fade {% if data.badge_type.id|stringformat:'s' == active_badge_id %}show active{% endif %}"
             id="badge-{{ data.badge_type.id }}"
             role="tabpanel">

            <div class="card">
                <div class="card-body">
                    {% if data.requests %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="30"><input type="checkbox" class="form-check-input select-all-approved" data-badge-type="{{ data.badge_type.id }}"></th>
                                    <th width="18%">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th width="12%">‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</th>
                                    <th width="15%">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th width="10%">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</th>
                                    <th width="12%">‡πÇ‡∏ã‡∏ô</th>
                                    <th width="10%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th width="10%" class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in data.requests %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input approved-checkbox" value="{{ req.id }}" data-badge-type="{{ data.badge_type.id }}">
                                    </td>
                                    <td>
                                        <strong>{{ req.staff_profile.first_line }} {{ req.staff_profile.last_line }}</strong>
                                        <small class="text-muted d-block">{{ req.staff_profile.department.name }}</small>
                                    </td>
                                    <td class="small">{{ req.staff_profile.national_id|default:"-" }}</td>
                                    <td>{{ req.staff_profile.position }}</td>
                                    <td>
                                        <span class="badge" style="background-color: {{ req.staff_profile.badge_type.color_code }};">
                                            {{ req.staff_profile.badge_type.name }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if req.staff_profile.zone %}
                                            <span class="badge bg-secondary">{{ req.staff_profile.zone.code }}</span>
                                            <small class="text-muted d-block">{{ req.staff_profile.zone.name }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge-status {{ req.status }}">
                                            {{ req.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'approvals:review_detail' req.id %}" class="btn btn-outline-primary" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-warning send-back-btn"
                                                    data-request-id="{{ req.id }}"
                                                    data-staff-name="{{ req.staff_profile.first_line }} {{ req.staff_profile.last_line }}"
                                                    data-send-back-url="{% url 'approvals:send_back_for_revision' req.id %}"
                                                    title="‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                                <i class="bi bi-arrow-counterclockwise"></i>
                                            </button>
                                            <a href="{% url 'badges:create_badge' req.id %}" class="btn btn-success" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£">
                                                <i class="bi bi-credit-card"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem;"></i>
                        <h5 class="mt-3">
                            {% if search %}
                                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "{{ search }}"
                            {% else %}
                                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
                            {% endif %}
                        </h5>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Bulk Edit Modal -->
<div class="modal fade" id="bulkEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="bulk-edit-form" action="{% url 'approvals:bulk_edit_approved' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç <strong><span id="bulk-edit-count">0</span></strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </div>

                    <div class="mb-3">
                        <label class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                        <input type="text" class="form-control" name="position" id="bulk-edit-position" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å = ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)">
                        <small class="form-text text-muted">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà/‡πÇ‡∏ã‡∏ô</label>
                        <select class="form-select" name="zone_id" id="bulk-edit-zone">
                            <option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á --</option>
                            {% for zone in zones %}
                            <option value="{{ zone.id }}">{{ zone.code }} - {{ zone.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á"</small>
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-pencil-square"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Create Badge Modal -->
<div class="modal fade" id="bulkCreateBadgeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-credit-card"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="bulk-create-badge-form" action="{% url 'badges:bulk_create_badge' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-primary">
                        <i class="bi bi-info-circle"></i>
                        ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong><span id="bulk-create-badge-count">0</span></strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong>
                        <ul class="mb-0 mt-2">
                            <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
                            <li>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°</li>
                            <li>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°</li>
                        </ul>
                    </div>
                    <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-credit-card"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Send Back for Revision Modal (Single) -->
<div class="modal fade" id="sendBackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-arrow-counterclockwise"></i> ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="send-back-form" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i>
                        ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á <strong id="send-back-staff-name"></strong>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö</strong> <span class="text-danger">*</span></label>
                        <select class="form-select mb-2" id="send-back-reason-select">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• --</option>
                            <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</option>
                            <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</option>
                            <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                            <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ã‡∏ô">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ã‡∏ô</option>
                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</option>
                        </select>
                        <textarea class="form-control" name="rejection_reason" id="send-back-reason-text" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" required></textarea>
                        <small class="form-text text-muted">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</small>
                    </div>

                    <div class="alert alert-info">
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong>
                        <ul class="mb-0 mt-2">
                            <li>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"</li>
                            <li>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ</li>
                            <li>‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-counterclockwise"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Send Back Modal -->
<div class="modal fade" id="bulkSendBackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-arrow-counterclockwise"></i> ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="bulk-send-back-form" action="{% url 'approvals:bulk_send_back_for_revision' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i>
                        ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö <strong><span id="bulk-send-back-count">0</span></strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö</strong> <span class="text-danger">*</span></label>
                        <select class="form-select mb-2" id="bulk-send-back-reason-select">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• --</option>
                            <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</option>
                            <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</option>
                            <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                            <option value="‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ã‡∏ô">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ã‡∏ô</option>
                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</option>
                        </select>
                        <textarea class="form-control" name="rejection_reason" id="bulk-send-back-reason-text" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" required></textarea>
                        <small class="form-text text-muted">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</small>
                    </div>

                    <div class="alert alert-danger">
                        <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong>
                        <ul class="mb-0 mt-2">
                            <li>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
                            <li>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ</li>
                            <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-arrow-counterclockwise"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Department filter function
function filterByDepartment(departmentId) {
    const urlParams = new URLSearchParams(window.location.search);

    if (departmentId) {
        urlParams.set('department', departmentId);
    } else {
        urlParams.delete('department');
    }

    // Keep search parameter if exists
    const search = '{{ search }}';
    if (search) {
        urlParams.set('search', search);
    }

    window.location.href = '?' + urlParams.toString();
}

(function() {
    'use strict';

    // Wait for DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    function init() {
        console.log('Initializing approved list tab memory and bulk actions...');
        initTabMemory();
        restoreActiveTab();
        initBulkActions();
    }

    // Tab Memory with localStorage
    function initTabMemory() {
        // Listen to all tab button clicks (note: this page uses "pill" not "tab")
        document.querySelectorAll('[data-bs-toggle="pill"]').forEach(function(tabButton) {
            tabButton.addEventListener('shown.bs.tab', function(event) {
                // Extract badge type ID from tab target
                const target = event.target.getAttribute('data-bs-target');
                const badgeTypeId = target.replace('#badge-', '');

                // Save to localStorage
                localStorage.setItem('approved_list_active_tab', badgeTypeId);
                console.log('Saved active tab (approved list):', badgeTypeId);
            });
        });
    }

    function restoreActiveTab() {
        // Get saved tab from localStorage
        const savedTab = localStorage.getItem('approved_list_active_tab');

        if (savedTab) {
            // Find and activate the saved tab
            const tabButton = document.getElementById('badge-' + savedTab + '-tab');
            if (tabButton) {
                const tab = new bootstrap.Tab(tabButton);
                tab.show();
                console.log('Restored active tab (approved list):', savedTab);
            }
        }
    }

    // Shared helper function for getting selected IDs
    function getSelectedIds() {
        const selectedCheckboxes = document.querySelectorAll('.approved-checkbox:checked');
        const ids = [];
        selectedCheckboxes.forEach(function(checkbox) {
            ids.push(checkbox.value);
        });
        return ids;
    }

    // Bulk Actions
    function initBulkActions() {
        const bulkActionsBar = document.getElementById('bulkActionsBar');
        const selectedCountSpan = document.getElementById('selectedCount');
        const bulkCreateBadgeBtn = document.getElementById('bulkCreateBadgeBtn');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');

        // Select all checkboxes
        document.querySelectorAll('.select-all-approved').forEach(function(selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const badgeType = this.getAttribute('data-badge-type');
                const checkboxes = document.querySelectorAll('.approved-checkbox[data-badge-type="' + badgeType + '"]');
                checkboxes.forEach(function(checkbox) {
                    checkbox.checked = selectAllCheckbox.checked;
                });
                updateBulkActionsBar();
            });
        });

        // Individual checkboxes
        document.querySelectorAll('.approved-checkbox').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                updateBulkActionsBar();

                // Update select-all checkbox for this badge type
                const badgeType = this.getAttribute('data-badge-type');
                const allCheckboxes = document.querySelectorAll('.approved-checkbox[data-badge-type="' + badgeType + '"]');
                const checkedCheckboxes = document.querySelectorAll('.approved-checkbox[data-badge-type="' + badgeType + '"]:checked');
                const selectAllCheckbox = document.querySelector('.select-all-approved[data-badge-type="' + badgeType + '"]');

                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
                }
            });
        });

        // Clear selection button
        if (clearSelectionBtn) {
            clearSelectionBtn.addEventListener('click', function() {
                document.querySelectorAll('.approved-checkbox:checked').forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                document.querySelectorAll('.select-all-approved:checked').forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                updateBulkActionsBar();
            });
        }

        // Bulk edit button
        const bulkEditBtn = document.getElementById('bulkEditBtn');
        if (bulkEditBtn) {
            bulkEditBtn.addEventListener('click', function() {
                const selectedIds = getSelectedIds();
                if (selectedIds.length === 0) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
                    return;
                }

                // Update count in modal
                const countSpan = document.getElementById('bulk-edit-count');
                if (countSpan) {
                    countSpan.textContent = selectedIds.length;
                }

                // Clear previous values
                document.getElementById('bulk-edit-position').value = '';
                document.getElementById('bulk-edit-zone').value = '';

                // Add hidden inputs to form
                const form = document.getElementById('bulk-edit-form');
                if (form) {
                    // Clear previous hidden inputs
                    const oldInputs = form.querySelectorAll('input[name="request_ids"]');
                    oldInputs.forEach(function(input) {
                        input.remove();
                    });

                    // Add new hidden inputs
                    selectedIds.forEach(function(id) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'request_ids';
                        input.value = id;
                        form.appendChild(input);
                    });
                }

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('bulkEditModal'));
                modal.show();
            });
        }

        // Bulk create badge button
        if (bulkCreateBadgeBtn) {
            bulkCreateBadgeBtn.addEventListener('click', function() {
                const selectedIds = getSelectedIds();
                if (selectedIds.length === 0) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£');
                    return;
                }

                // Update count in modal
                const countSpan = document.getElementById('bulk-create-badge-count');
                if (countSpan) {
                    countSpan.textContent = selectedIds.length;
                }

                // Add hidden inputs to form
                const form = document.getElementById('bulk-create-badge-form');
                if (form) {
                    // Clear previous hidden inputs
                    const oldInputs = form.querySelectorAll('input[name="request_ids"]');
                    oldInputs.forEach(function(input) {
                        input.remove();
                    });

                    // Add new hidden inputs
                    selectedIds.forEach(function(id) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'request_ids';
                        input.value = id;
                        form.appendChild(input);
                    });
                }

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('bulkCreateBadgeModal'));
                modal.show();
            });
        }

        function updateBulkActionsBar() {
            const selectedCheckboxes = document.querySelectorAll('.approved-checkbox:checked');
            const count = selectedCheckboxes.length;

            if (selectedCountSpan) {
                selectedCountSpan.textContent = count;
            }

            if (bulkActionsBar) {
                bulkActionsBar.style.display = count > 0 ? 'block' : 'none';
            }
        }

        // Handle form submission - disable button to prevent double submit
        const createBadgeForm = document.getElementById('bulk-create-badge-form');
        if (createBadgeForm) {
            createBadgeForm.addEventListener('submit', function() {
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£...';
                }
            });
        }
    }

    // Send Back for Revision functionality
    function initSendBack() {
        const sendBackButtons = document.querySelectorAll('.send-back-btn');
        const sendBackModal = document.getElementById('sendBackModal');
        const sendBackForm = document.getElementById('send-back-form');
        const sendBackStaffName = document.getElementById('send-back-staff-name');
        const sendBackReasonSelect = document.getElementById('send-back-reason-select');
        const sendBackReasonText = document.getElementById('send-back-reason-text');

        sendBackButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                const staffName = this.getAttribute('data-staff-name');
                const sendBackUrl = this.getAttribute('data-send-back-url');

                // Set staff name in modal
                sendBackStaffName.textContent = staffName;

                // Set form action from data attribute
                sendBackForm.action = sendBackUrl;

                // Clear previous values
                sendBackReasonSelect.value = '';
                sendBackReasonText.value = '';

                // Show modal
                const modal = new bootstrap.Modal(sendBackModal);
                modal.show();
            });
        });

        // When selecting a reason from dropdown, auto-fill textarea
        if (sendBackReasonSelect) {
            sendBackReasonSelect.addEventListener('change', function() {
                const selectedValue = this.value;
                if (selectedValue && selectedValue !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                    sendBackReasonText.value = selectedValue;
                } else if (selectedValue === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                    sendBackReasonText.value = '';
                    sendBackReasonText.focus();
                }
            });
        }

        // Handle form submission
        if (sendBackForm) {
            sendBackForm.addEventListener('submit', function(e) {
                const reason = sendBackReasonText.value.trim();
                if (!reason) {
                    e.preventDefault();
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö');
                    return false;
                }

                // Disable submit button to prevent double submit
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö...';
                }
            });
        }
    }

    // Initialize send back functionality
    initSendBack();

    // Bulk Send Back functionality
    function initBulkSendBack() {
        const bulkSendBackBtn = document.getElementById('bulkSendBackBtn');
        const bulkSendBackModal = document.getElementById('bulkSendBackModal');
        const bulkSendBackForm = document.getElementById('bulk-send-back-form');
        const bulkSendBackCount = document.getElementById('bulk-send-back-count');
        const bulkSendBackReasonSelect = document.getElementById('bulk-send-back-reason-select');
        const bulkSendBackReasonText = document.getElementById('bulk-send-back-reason-text');

        if (bulkSendBackBtn) {
            bulkSendBackBtn.addEventListener('click', function() {
                const selectedIds = getSelectedIds();
                if (selectedIds.length === 0) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö');
                    return;
                }

                // Update count in modal
                if (bulkSendBackCount) {
                    bulkSendBackCount.textContent = selectedIds.length;
                }

                // Clear previous values
                bulkSendBackReasonSelect.value = '';
                bulkSendBackReasonText.value = '';

                // Add hidden inputs to form
                if (bulkSendBackForm) {
                    // Clear previous hidden inputs
                    const oldInputs = bulkSendBackForm.querySelectorAll('input[name="request_ids"]');
                    oldInputs.forEach(function(input) {
                        input.remove();
                    });

                    // Add new hidden inputs
                    selectedIds.forEach(function(id) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'request_ids';
                        input.value = id;
                        bulkSendBackForm.appendChild(input);
                    });
                }

                // Show modal
                const modal = new bootstrap.Modal(bulkSendBackModal);
                modal.show();
            });
        }

        // When selecting a reason from dropdown, auto-fill textarea
        if (bulkSendBackReasonSelect) {
            bulkSendBackReasonSelect.addEventListener('change', function() {
                const selectedValue = this.value;
                if (selectedValue && selectedValue !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                    bulkSendBackReasonText.value = selectedValue;
                } else if (selectedValue === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                    bulkSendBackReasonText.value = '';
                    bulkSendBackReasonText.focus();
                }
            });
        }

        // Handle form submission
        if (bulkSendBackForm) {
            bulkSendBackForm.addEventListener('submit', function(e) {
                const reason = bulkSendBackReasonText.value.trim();
                if (!reason) {
                    e.preventDefault();
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö');
                    return false;
                }

                // Disable submit button to prevent double submit
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö...';
                }
            });
        }
    }

    // Initialize bulk send back functionality
    initBulkSendBack();
})();
</script>
{% endblock %}
